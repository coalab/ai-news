<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>기사 상세 | AI NEWS</title>
  <meta name="description" content="AI 뉴스 기사 상세 페이지">
  <link rel="stylesheet" href="css/board.css">
</head>
<body>

<header class="site-header">
  <div class="wrap">
    <a href="index.html" class="site-logo">AI<span>NEWS</span></a>
    <nav class="site-nav">
      <a href="index.html">홈</a>
      <a href="board.html">기사 게시판</a>
      <a href="admin.html">관리자</a>
    </nav>
  </div>
</header>

<div class="content-wrap">
  <div id="article-content">
    <div class="loading">기사를 불러오는 중</div>
  </div>
</div>

<footer class="site-footer">
  &copy; 2026 AI NEWS &middot; <a href="board.html">게시판으로 돌아가기</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = 'https://onfddgmyzkeaxidpdwra.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uZmRkZ215emtlYXhpZHBkd3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NzgwMDcsImV4cCI6MjA3ODI1NDAwN30.pwzxOD_6TEQT-KWZzvvlIXCnR6qr_9kN6jFf57FtAwo';
  const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  async function getCurrentUser() {
    const { data: { session } } = await _supabase.auth.getSession();
    return session?.user || null;
  }
</script>
<script>
  const params = new URLSearchParams(window.location.search);
  const articleId = params.get('id');

  async function loadArticle() {
    const container = document.getElementById('article-content');

    if (!articleId) {
      container.innerHTML = '<div class="alert alert-error">기사 ID가 지정되지 않았습니다.</div><p><a href="board.html">게시판으로 돌아가기</a></p>';
      return;
    }

    const { data, error } = await _supabase
      .from('articles')
      .select('*')
      .eq('id', articleId)
      .single();

    if (error || !data) {
      container.innerHTML = '<div class="alert alert-error">기사를 찾을 수 없습니다.</div><p><a href="board.html">게시판으로 돌아가기</a></p>';
      return;
    }

    _supabase.rpc('increment_view_count', { article_id: articleId }).then();

    document.title = data.title + ' | AI NEWS';

    const date = new Date(data.created_at).toLocaleDateString('ko-KR', {
      year: 'numeric', month: 'long', day: 'numeric'
    });
    const updatedDate = data.updated_at && data.updated_at !== data.created_at
      ? new Date(data.updated_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })
      : null;

    let html = `
      <article class="article-detail">
        <span class="category-badge" style="margin-bottom:12px">${escapeHtml(data.category || '일반')}</span>
        <h1>${escapeHtml(data.title)}</h1>
        <div class="article-meta">
          <span>작성자: ${escapeHtml(data.author || '관리자')}</span>
          <span>작성일: ${date}</span>
          ${updatedDate ? `<span>수정일: ${updatedDate}</span>` : ''}
          <span>조회수: ${(data.view_count || 0) + 1}</span>
        </div>
    `;

    if (data.thumbnail_url) {
      html += `<img src="${escapeHtml(data.thumbnail_url)}" alt="${escapeHtml(data.title)}" style="max-width:100%;border-radius:12px;margin-bottom:20px">`;
    }

    html += `<div class="article-body">${data.content}</div>`;

    html += `
        <div class="article-actions" id="admin-actions" style="display:none">
          <a href="write.html?id=${data.id}" class="btn btn-secondary">수정</a>
          <button class="btn btn-danger" onclick="deleteArticle('${data.id}')">삭제</button>
        </div>
      </article>
    `;

    container.innerHTML = html;

    const user = await getCurrentUser();
    if (user) {
      document.getElementById('admin-actions').style.display = 'flex';
    }
  }

  async function deleteArticle(id) {
    if (!confirm('정말로 이 기사를 삭제하시겠습니까?')) return;

    const { error } = await _supabase
      .from('articles')
      .delete()
      .eq('id', id);

    if (error) {
      alert('삭제 실패: ' + error.message);
      return;
    }

    alert('기사가 삭제되었습니다.');
    window.location.href = 'board.html';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  loadArticle();
</script>

</body>
</html>
