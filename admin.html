<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ê´€ë¦¬ì | AI NEWS</title>
  <meta name="description" content="AI ë‰´ìŠ¤ ê´€ë¦¬ì í˜ì´ì§€">
  <link rel="stylesheet" href="css/board.css">
</head>
<body>

<header class="site-header">
  <div class="wrap">
    <a href="index.html" class="site-logo">AI<span>NEWS</span></a>
    <nav class="site-nav">
      <a href="index.html">í™ˆ</a>
      <a href="board.html">ê¸°ì‚¬ ê²Œì‹œíŒ</a>
      <a href="admin.html" class="active">ê´€ë¦¬ì</a>
      <a href="#" id="logout-btn" style="display:none" onclick="handleLogout(event)">ë¡œê·¸ì•„ì›ƒ</a>
    </nav>
  </div>
</header>

<!-- ë¡œê·¸ì¸ í¼ -->
<div id="login-section">
  <div class="login-box">
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <div id="login-error" class="alert alert-error" style="display:none"></div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label for="email">ì´ë©”ì¼</label>
        <input type="email" id="email" required placeholder="admin@example.com">
      </div>
      <div class="form-group">
        <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="password" required placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%;margin-top:8px" id="login-submit">ë¡œê·¸ì¸</button>
    </form>
  </div>
</div>

<!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
<div id="dashboard-section" style="display:none">
  <div class="content-wrap">
    <div class="dashboard-stats">
      <div class="stat-card">
        <div class="stat-number" id="stat-total">-</div>
        <div class="stat-label">ì „ì²´ ê¸°ì‚¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-published">-</div>
        <div class="stat-label">ê³µê°œ ê¸°ì‚¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-draft">-</div>
        <div class="stat-label">ë¹„ê³µê°œ ê¸°ì‚¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-views">-</div>
        <div class="stat-label">ì´ ì¡°íšŒìˆ˜</div>
      </div>
    </div>

    <div class="toolbar">
      <input type="text" id="admin-search" placeholder="ê¸°ì‚¬ ê²€ìƒ‰...">
      <select id="admin-status-filter">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <option value="true">ê³µê°œ</option>
        <option value="false">ë¹„ê³µê°œ</option>
      </select>
      <button class="btn btn-secondary" onclick="adminPage=1;loadDashboard()">ê²€ìƒ‰</button>
      <a href="write.html" class="btn btn-primary" style="margin-left:auto">ìƒˆ ê¸°ì‚¬ ì‘ì„±</a>
    </div>

    <div id="admin-article-list">
      <div class="loading">ê¸°ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <div class="pagination" id="admin-pagination"></div>
  </div>
</div>

<footer class="site-footer">
  &copy; 2026 AI NEWS &middot; ê´€ë¦¬ì í˜ì´ì§€
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = 'https://onfddgmyzkeaxidpdwra.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uZmRkZ215emtlYXhpZHBkd3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NzgwMDcsImV4cCI6MjA3ODI1NDAwN30.pwzxOD_6TEQT-KWZzvvlIXCnR6qr_9kN6jFf57FtAwo';
  const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function getCurrentUser() {
    const { data: { session } } = await _supabase.auth.getSession();
    return session?.user || null;
  }
  async function signIn(email, password) {
    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
    if (error) throw error;
    return data;
  }
  async function signOut() {
    const { error } = await _supabase.auth.signOut();
    if (error) throw error;
  }
</script>
<script>
  const ADMIN_PAGE_SIZE = 15;
  let adminPage = 1;
  let adminTotal = 0;

  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errorEl = document.getElementById('login-error');
    const submitBtn = document.getElementById('login-submit');

    errorEl.style.display = 'none';
    submitBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
    submitBtn.disabled = true;

    try {
      await signIn(email, password);
      showDashboard();
    } catch (err) {
      errorEl.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message;
      errorEl.style.display = 'block';
    } finally {
      submitBtn.textContent = 'ë¡œê·¸ì¸';
      submitBtn.disabled = false;
    }
  }

  async function handleLogout(e) {
    e.preventDefault();
    await signOut();
    showLogin();
  }

  function showLogin() {
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('dashboard-section').style.display = 'none';
    document.getElementById('logout-btn').style.display = 'none';
  }

  function showDashboard() {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('dashboard-section').style.display = 'block';
    document.getElementById('logout-btn').style.display = 'inline-block';
    loadDashboard();
    loadStats();
  }

  async function loadStats() {
    const { data: allArticles } = await _supabase
      .from('articles')
      .select('published, view_count');

    if (!allArticles) return;

    const total = allArticles.length;
    const published = allArticles.filter(a => a.published).length;
    const draft = total - published;
    const views = allArticles.reduce((sum, a) => sum + (a.view_count || 0), 0);

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-published').textContent = published;
    document.getElementById('stat-draft').textContent = draft;
    document.getElementById('stat-views').textContent = views.toLocaleString();
  }

  async function loadDashboard() {
    const listEl = document.getElementById('admin-article-list');
    const searchQuery = document.getElementById('admin-search').value.trim();
    const statusFilter = document.getElementById('admin-status-filter').value;

    listEl.innerHTML = '<div class="loading">ê¸°ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>';

    const from = (adminPage - 1) * ADMIN_PAGE_SIZE;
    const to = from + ADMIN_PAGE_SIZE - 1;

    let query = _supabase
      .from('articles')
      .select('id, title, author, category, published, view_count, created_at', { count: 'exact' })
      .order('created_at', { ascending: false })
      .range(from, to);

    if (searchQuery) {
      query = query.ilike('title', `%${searchQuery}%`);
    }
    if (statusFilter !== '') {
      query = query.eq('published', statusFilter === 'true');
    }

    const { data, error, count } = await query;

    if (error) {
      listEl.innerHTML = '<div class="alert alert-error">ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</div>';
      return;
    }

    adminTotal = count || 0;

    if (!data || data.length === 0) {
      listEl.innerHTML = '<div class="empty-state"><div class="emoji">ğŸ“­</div><p>ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      document.getElementById('admin-pagination').innerHTML = '';
      return;
    }

    let html = `
      <table class="board-table">
        <thead>
          <tr>
            <th style="width:40%">ì œëª©</th>
            <th>ì¹´í…Œê³ ë¦¬</th>
            <th>ìƒíƒœ</th>
            <th>ì¡°íšŒ</th>
            <th>ì‘ì„±ì¼</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.forEach(article => {
      const date = new Date(article.created_at).toLocaleDateString('ko-KR');
      const statusLabel = article.published ? 'ê³µê°œ' : 'ë¹„ê³µê°œ';
      const statusColor = article.published ? 'var(--accent)' : '#999';

      html += `
        <tr>
          <td class="title-cell">
            <a href="article.html?id=${article.id}">${escapeHtml(article.title)}</a>
          </td>
          <td><span class="category-badge">${escapeHtml(article.category || 'ì¼ë°˜')}</span></td>
          <td><span style="color:${statusColor};font-weight:600;font-size:13px">${statusLabel}</span></td>
          <td>${article.view_count || 0}</td>
          <td>${date}</td>
          <td>
            <a href="write.html?id=${article.id}" class="btn btn-secondary btn-sm">ìˆ˜ì •</a>
            <button class="btn btn-danger btn-sm" onclick="deleteArticle('${article.id}')">ì‚­ì œ</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    listEl.innerHTML = html;

    renderAdminPagination();
  }

  function renderAdminPagination() {
    const totalPages = Math.ceil(adminTotal / ADMIN_PAGE_SIZE);
    const el = document.getElementById('admin-pagination');

    if (totalPages <= 1) { el.innerHTML = ''; return; }

    let html = `<button ${adminPage === 1 ? 'disabled' : ''} onclick="goAdminPage(${adminPage - 1})">&laquo;</button>`;

    const start = Math.max(1, adminPage - 2);
    const end = Math.min(totalPages, adminPage + 2);

    if (start > 1) {
      html += `<button onclick="goAdminPage(1)">1</button>`;
      if (start > 2) html += `<button disabled>...</button>`;
    }

    for (let i = start; i <= end; i++) {
      html += `<button class="${i === adminPage ? 'active' : ''}" onclick="goAdminPage(${i})">${i}</button>`;
    }

    if (end < totalPages) {
      if (end < totalPages - 1) html += `<button disabled>...</button>`;
      html += `<button onclick="goAdminPage(${totalPages})">${totalPages}</button>`;
    }

    html += `<button ${adminPage === totalPages ? 'disabled' : ''} onclick="goAdminPage(${adminPage + 1})">&raquo;</button>`;
    el.innerHTML = html;
  }

  function goAdminPage(page) {
    adminPage = page;
    loadDashboard();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function deleteArticle(id) {
    if (!confirm('ì •ë§ë¡œ ì´ ê¸°ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await _supabase
      .from('articles')
      .delete()
      .eq('id', id);

    if (error) {
      alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      return;
    }

    loadDashboard();
    loadStats();
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  document.getElementById('admin-search').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { adminPage = 1; loadDashboard(); }
  });

  (async () => {
    const user = await getCurrentUser();
    if (user) {
      showDashboard();
    } else {
      showLogin();
    }
  })();
</script>

</body>
</html>
